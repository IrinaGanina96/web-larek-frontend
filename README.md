# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в  приложении

Карточка товара

```
export interface ICard {
    id: string;
    description: string;
    image: string;
    title: string;
    category: string;
    price: number | null;
}
```

Пользователь

```
export interface IUser {
    payment: string;
    address: string;
    email: string;
    tel: string;
}
```

Интерфейс для коллекции карточек

```
export interface ICardsData {
    cards: ICard[];
    preview: string | null;
    getCards(): ICard[];
    getCardPreview(id:string):ICard;
    setCards(cards: ICard[]):void;
}
```

Интерфейс корзины с товарами

```
export interface IBasketData {
    cards: TCardBasket[];
    addCard(id:string):void;
    removeCard(id:string):void;
    clearBasket():void;
    getTotal():number;
    getCounter():number;
}
```

Данные карточки товара, отображаемые на главной странице

```
export type TCardPublic = Pick<ICard, 'title'|'image'|'category'|'price'>;
```

Данные карточки товара, отображаемые в корзине

```
export type TCardBasket = Pick<ICard, 'title'|'price'>;
```

Данные пользователя при оформении заказа в форме заполнения способа оплаты и адреса

```
export type TUserPay = Pick<IUser, 'payment'|'address'>;
```

Данные пользователя при оформении заказа в форме заполнения почты и телефона

```
export type TUserContact = Pick<IUser, 'email'|'tel'>;
```

Методы  Api
```
export type ApiPostMethods = 'POST' | 'PUT' | 'DELETE';
```

Интерфейс Api

```
export interface IApi {
    baseUrl: string;
    get<T>(uri:string): Promise<T>;
    post<T>(uri:string, data:object, method?:ApiPostMethods): Promise<T>;
}
```

Данные ошибок при валидации форм

```
export type FormErrorsPay = Partial<Record<keyof TUserPay, string>>;
export type FormErrorsContact = Partial<Record<keyof TUserContact, string>>;
```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP:
- слой представления, отвечает за отображение данных на странице,
- слой данных, отвечает за хранение и изменение данных,
- презентер, овтечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объекит с заголовками запросов.
Методы:
- `get` - выполняет `GET` запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса мжет быть переопределн заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения дляя генерации событий. 
Основные методы, реализуемые классов описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `off` - снятие обработчика с события
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие

### Слой данных

#### Класс CardsData
Класс отвечает за хранение и логику работы с данными карточек товаров.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
- _cards: ICard[] - массив объектов каточек
- _preview: string | null - id карточки, выбранной для просмотра в модальном окне
- events: IEvents - экземпляр класса `EventEmitter` для инициализации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными:
- сеттеры и геттеры - отвечающие за массив карточек
- getCardPreview(id:string):ICard - получает карточку по ее id

#### Класс BasketData
Класс отвечает за хранение и логику работы с данными по оформлению заказа.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
- cards: TCardBasket[] - массив объектов каточек, добавленных в корзину
- total: number - общая сумма
- events: IEvents - экземпляр класса `EventEmitter` для инициализации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными:
- addCard(card: ICard):void - добавляет карточку товара в корзину
- removeCard(id:string):void - удаляет карточку товара из корзины
- clearBasket():void - очищает корзину
- getTotal():number - получает общую стоимость товаров, добавленных в корзину
- getCounter():number - получает количество добавленных товаров в корзину
- cardInBasket(id:string): boolean - определение есть ли товар в корзине
- getItemsIds(): string[] - получение массива id карточек, находящихся в корзине

#### Класс UserData
Класс отвечает за хранение и логику работы с данными пользователя для оформлению заказа.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
- payment: string - способ оплаты
- address: string - адрес заказа
- email: string - почта
- phone: string - телефон
- formErrorsPay: FormErrorsPay = {}
- FormErrors: FormErrorsContact = {};
- events: IEvents - экземпляр класса `EventEmitter` для инициализации событий при изменении данных.

Так же класс предоставляет набор методов для взаимодействия с этими данными:
- getUserData() - получение данных для заказа
- setUserPay(payData:TUserPay): void - сохранение способа оплаты
- setUserContact(contactData:TUserContact): void - сохранение адреса доставки
- setPayment(value: string):void - сохранение сопсоба оплаты
- getPayment(): string - получение способа оплаты
- setOrderField(field: keyof TUserPay, value: string) - получение информации о проверки на валидность формы
- validateUserPay(): boolean - проверяет объект с данными на валидность
- setContactField(field: keyof TUserContact, value: string) - получение информации о проверки на валидность формы
- validateUserContact(): boolean - проверяет объект с данными на валидность

### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Базовый класс Component
Класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Содержит метод render, отвечающий за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.

#### Класс Modal
Реализует модальное окно. Так же предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по ESC, на клик в оверлей и на кнопку-крестик для закрытия модального окна.
- constructor(container: HTMLElement, protected events: IEvents) - конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса:
- _content: HTMLElement - элемент модального окна
- _closeButton: HTMLButtonElement - кнопка закрытия
- events: IEvents - брокер событий

Методы:
- set content(value: HTMLElement) - принимает объект с данными для отображения в модальном окне
- open() - открытие модального окна
- close() - закрытие модального окна
- render(): HTMLElement - отрисовывает модальное окно с полученными для отображения данными

#### Класс Form
Реализует форму. Он обеспечивает обработку событий ввода и отправки, так же управляет состоянием валидности и отображения формы. 
- constructor(protected container: HTMLFormElement, protected events: IEvents) - конструктор принимает темплейт формы и экземпляр класса `EventEmitter` для возможности инициации событий.

Поля класса: 
- _submit: HTMLButtonElement - кнопка подтверждения
- _errors: HTMLElement - объект хранящий все элементы для вывода ошибок под полями формы с привязкой к атрибуту name импутов

Методы:
- set valid(isValid:boolean): void - изменяет активность кнопки подтвержения в зависимости от прохождения валидации
- set errors(data: {field:string, value:string, validInformation:string}): void - принимает объект с данными для отображения или скрытия текстов ошибок под полями ввода {в каком поле, какие данные введены и какой текст ошибки}
- render(): HTMLElement - отрисовывает форму, отображая валидность, ошибки и данные полей ввода

#### Класс Card
Отвечает за отображение карточки, задавая в карточке данные названия товара, изображения, описания, категории товара к которой он относится, стоимость товара. Класс используется для отображения карточек на странице сайта. В конструктор класса передается DOM элемент темплейта, что позволяет формировать карточки разных вариантов верстки (на главной странице, в модальном окне, в корзине). В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми пользователя генерируются соответсвующие события.\
Поля класса содержат элементы разметки элементов карточки. Конструктор, кроме темплейта принимает экземпляр класса `EventEmitter` для возможности инициации событий.

Методы:
- геттер id возвращает уникальный id карточки
- events: IEvents - брокер событий

#### Класс Page
Отвечает за отображение главной страницы. В конструктор принимает DOM-элемент главной страницы и экземпляр класса `EventEmitter` для возможности инициации событий.
- constructor(protected container: HTMLElement, protected events: IEvents)

Поля класса:
- _catalog: HTMLElement[] - каталог с карточками товаров
- _basket: HTMLElement - элемент корзины
- _counter: number - счетчик количества товаров в корзине
- _wrapper: boolean - блокировка страницы, если например открыто модальное окно
- events: IEvents - брокер событий

Методы:
- set сatalog(cards: HTMLElement[]) - задает содержимое каталога
- set сounter(value: number) - устанавливает количество товаров в корзине 
- set locked(value: boolean) - устанавливает и убирает блокировку в зависимости от переданного значения

#### Класс Basket
Отвечает за отображение в модальном окне списка товаров добавленных в корзину. В конструктор принимает DOM-элемент и экземпляр класса `EventEmitter` для возможности инициации событий.
- constructor(container: HTMLElement, protected events: IEvents)

Поля класса:
- cards: HTMLElement[] - карточки товаров, добавленные в корзину
- total: number - общая стоимость товаров, добавленных в корзину
- buttonBasket: HTMLButtonElement - кнопка оформления покупки

Методы:
- set сards(cards: HTMLElement[]) - сохранение товаров в корзине
- set total(total: number) - считает общую стоимость товаров, добавленных в корзину

#### Класс UserPay
Является дочерним классом класса `Form` и отвечает за отображение модального окна с формой выбора способа оплаты и заполнения адреса доставки. В конструктор принимает DOM-элемент и экземпляр класса `EventEmitter` для возможности инициации событий.
constructor(container: HTMLFormElement, events: IEvents)

Поля класса:
- onlineButton: HTMLButtonElement - кнопка онлайн оплаты
- offlineButton: HTMLButtonElement - кнопка оплаты при получении
- _address: HTMLElement - инпут для заполнения адреса доставки

Методы:
- set payment (value:string) - сохраняет выбранный способ оплаты (одна из кнопок активная)
- set address (value:string) - сохраняет введенный адрес

#### Класс UserContact
Является дочерним классом класса `Form` и отвечает за отображение модального окна с формой заполнения e-mail и телефона. В конструктор принимает DOM-элемент и экземпляр класса `EventEmitter` для возможности инициации событий.
constructor(container: HTMLFormElement, events: IEvents)

Поля класса:
- _email: HTMLElement - инпут для заполнения почты
- _phone: HTMLElement - инпут для заполнения телефона

Методы:
- set email (value:string) - сохраняет введенный e-mail
- set phone (value:string) - сохраняет введенный телефон

#### Класс Success
Отвечает за отображение модального окна с успешным завершением заказа и итоговой суммой заказа. В конструктор принимает DOM-элемент и колбэк для вызова при нажатии на кнопку в окне.
(container: HTMLElement, actions?: ISuccessActions)

Поля класса:
- _total: number - общая стоимость товаров
- buttonSuccess: HTMLButtonElement - кнопка подтвержения заказа

Методы:
- setTotal(total: number) - отображает общую стоимость товаров

### Слой коммуникации

#### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы, реализующие взаимодействие с бэкендом сервиса.

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющий роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`.\
В `index.ts` сначала создаются экземпляры необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\
*События изменения данных (генерируются классами моделями данных)*
- `cards:changed` - изменение массива карточек
- `card:selected` - изменение открываемой в модальном окне карточки товара
- `basket:changed` - изменение корзины
- `counter:changed` - изменение счетчика товаров на корзине
- `card:previewClear`- необходима очистка данных выбранной для показа в модальном окне карточки

*События, возникающие при взаимодействии пользователя с интерфесом(генерируются классами, отвечающими за представление)*
- `card:select` - выбор карточки товара для отображения в модальном окне
- `card:add` - добавление карточки товара в корзину
- `card:remove` - удаление карточки товара из корзины
- `modal:open` - открытие модального окна
- `modal:close` - закрытие модального окнаа
- `basket:open` - открытие модального окна корзины
- `userPay:open` - открытие модального окна с выбором способа оплаты и заполнением адреса доставки
- `order.address:input` - изменение данных в форме с заполнением адреса доставки
- `order.pay:input` - изменение данных в форме с выбором способа оплаты
- `pay:changed` - получение способа оплаты
- `contacts.email:input` - изменение данных в форме с заполнением e-mail
- `contacts.tel:input` - изменение данных в форме с заполнением телефона
- `order:ready` - успешное прохождение валидации в форме с выбором способа оплаты и заполнением адреса
- `contacts:ready` - успешное прохождение валидации в форме с заполнением e-mail и телефона
- `formErrors:change` - ошибки при валидации
- `order:submit` - сохранение данных с выбором способа оплаты и заполнением адреса доставки
- `contacts:submit` - сохранение данных с заполнением e-mail и телефона
- `success:submit` - событие, генерируемое при успешном оформлении заказа